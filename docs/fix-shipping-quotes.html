<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Shipping Quotes - Auto-populate Missing CJ Variant IDs</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }
    .subtitle {
      color: #7f8c8d;
      margin-bottom: 2rem;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #17a2b8;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    button {
      background: #ff6600;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
    }
    button:hover { background: #e65500; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .step {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid #ff6600;
      margin-bottom: 1rem;
    }
    .step-number {
      display: inline-block;
      background: #ff6600;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      margin-right: 0.5rem;
      font-weight: bold;
      font-size: 0.9rem;
    }
    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .fixed-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
    }
    .fixed-item {
      padding: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      font-size: 0.9rem;
    }
    .fixed-item:last-child { border-bottom: none; }
    .vid { 
      font-family: 'Courier New', monospace; 
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üö¢ Fix Shipping Quotes</h1>
    <p class="subtitle">Auto-populate missing CJ Variant IDs (cj_vid)</p>

    <div class="warning">
      <strong>‚ö†Ô∏è Problem:</strong> Your cart shows "Estimated" shipping instead of real CJ quotes because products in the database are missing <code>cj_vid</code> (variant IDs).
    </div>

    <div class="info">
      <strong>‚ÑπÔ∏è How This Works:</strong><br>
      This tool will:
      <ol style="margin-top: 0.5rem; margin-left: 1.5rem;">
        <li>Find all products with <code>cj_pid</code> but no <code>cj_vid</code></li>
        <li>Fetch each product's variants from CJ Dropshipping API</li>
        <li>Auto-select the first/default variant</li>
        <li>Update your database with the <code>cj_vid</code></li>
      </ol>
    </div>

    <div class="step">
      <span class="step-number">1</span>
      <strong>Click the button below to auto-fix missing variant IDs:</strong>
    </div>

    <button id="fixBtn" onclick="fixMissingVids()">
      üîß Auto-Fix Missing Variant IDs
    </button>

    <div id="result" style="margin-top: 1.5rem;"></div>
  </div>

  <div class="card">
    <h2 style="margin-bottom: 1rem;">üìã After Running the Fix</h2>
    
    <div class="step">
      <span class="step-number">2</span>
      <strong>Clear Your Cart</strong>
      <p style="margin-top: 0.5rem; color: #666;">
        Important! Items already in your cart won't have the new <code>cj_vid</code>. 
        You must clear your cart and re-add products.
      </p>
    </div>

    <div class="step">
      <span class="step-number">3</span>
      <strong>Re-add Products from Store</strong>
      <p style="margin-top: 0.5rem; color: #666;">
        Browse your store and add products to cart again. They will now include the variant IDs.
      </p>
    </div>

    <div class="step">
      <span class="step-number">4</span>
      <strong>Verify Real Shipping Quotes Appear</strong>
      <p style="margin-top: 0.5rem; color: #666;">
        Open your cart. You should now see shipping methods from CJ (not "Estimated").
      </p>
    </div>
  </div>

  <script>
    const API_BASE = 'https://snuggleup-backend.onrender.com';

    async function fixMissingVids() {
      const btn = document.getElementById('fixBtn');
      const resultDiv = document.getElementById('result');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Fixing...';
      
      resultDiv.innerHTML = '<div class="info">Fetching products with missing variant IDs from CJ API...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/admin/products/fix-missing-vids`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Add your admin token here if you have authentication
            // 'Authorization': 'Bearer YOUR_ADMIN_TOKEN'
          }
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }

        let html = `<div class="success"><strong>‚úÖ Success!</strong><br>${data.message}</div>`;

        if (data.fixed && data.fixed.length > 0) {
          html += `<h3 style="margin-top: 1rem; color: #27ae60;">Fixed Products (${data.fixed.length})</h3>`;
          html += '<div class="fixed-list">';
          data.fixed.forEach(item => {
            html += `
              <div class="fixed-item">
                <strong>${item.name}</strong><br>
                <small>Product ID: ${item.id} ‚Ä¢ VID: <span class="vid">${item.cj_vid}</span></small>
              </div>
            `;
          });
          html += '</div>';
        }

        if (data.failed && data.failed.length > 0) {
          html += `<h3 style="margin-top: 1rem; color: #dc3545;">Failed Products (${data.failed.length})</h3>`;
          html += '<div class="fixed-list">';
          data.failed.forEach(item => {
            html += `
              <div class="fixed-item">
                <strong>${item.name}</strong><br>
                <small style="color: #dc3545;">Reason: ${item.reason}</small>
              </div>
            `;
          });
          html += '</div>';
        }

        if (data.fixed && data.fixed.length === 0 && (!data.failed || data.failed.length === 0)) {
          html = '<div class="info"><strong>‚ÑπÔ∏è All Set!</strong><br>All active products already have variant IDs. No fixes needed.</div>';
        }

        resultDiv.innerHTML = html;
        btn.textContent = '‚úì Complete';

      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Error:</strong><br>
            ${error.message}
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer;">Details</summary>
              <pre>${error.stack || error.toString()}</pre>
            </details>
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'üîß Try Again';
      }
    }
  </script>
</body>
</html>
